// import { relationalStore } from '@kit.ArkData'
// import { BusinessError } from '@kit.BasicServicesKit'
// import { DocumentItem } from '../model/DocumentItem'
// import { DocumentTypeInfo } from '../types/DocumentRecognition'
//
// // å®šä¹‰ JSON æ¥å£
// interface DocumentItemJSON {
//   id?: string
//   name?: string
//   type?: string
//   number?: string
//   expiryDate?: string
//   imageUrl?: string
//   createTime?: string
//   updateTime?: string
//   dynamicFields?: Record<string, string>
//   recognitionConfidence?: number
//   originalImagePath?: string
// }
//
// export class DocumentDatabaseManager {
//   private static instance: DocumentDatabaseManager
//   private rdbStore: relationalStore.RdbStore | null = null
//   private context: Context | null = null
//
//   // æ•°æ®åº“é…ç½®
//   private static readonly STORE_CONFIG: relationalStore.StoreConfig = {
//     name: 'DocumentManager.db',
//     securityLevel: relationalStore.SecurityLevel.S3,
//     encrypt: false,
//     isReadOnly: false
//   }
//
//   // æ•°æ®åº“ç‰ˆæœ¬
//   private static readonly CURRENT_VERSION = 1
//
//   // å»ºè¡¨SQL
//   private static readonly SQL_CREATE_DOCUMENTS_TABLE = `
//     CREATE TABLE IF NOT EXISTS documents (
//       id TEXT PRIMARY KEY,
//       name TEXT NOT NULL,
//       type TEXT NOT NULL,
//       number TEXT,
//       expiryDate TEXT,
//       imageUrl TEXT,
//       createTime TEXT NOT NULL,
//       updateTime TEXT NOT NULL,
//       dynamicFields TEXT,
//       recognitionConfidence REAL DEFAULT 0,
//       originalImagePath TEXT
//     )
//   `
//
//   private static readonly SQL_CREATE_DOCUMENT_TYPES_TABLE = `
//     CREATE TABLE IF NOT EXISTS document_types (
//       type TEXT PRIMARY KEY,
//       displayName TEXT NOT NULL,
//       icon TEXT,
//       count INTEGER DEFAULT 0
//     )
//   `
//
//   private constructor() {}
//
//   static getInstance(): DocumentDatabaseManager {
//     if (!DocumentDatabaseManager.instance) {
//       DocumentDatabaseManager.instance = new DocumentDatabaseManager()
//     }
//     return DocumentDatabaseManager.instance
//   }
//
//   // åˆå§‹åŒ–æ•°æ®åº“
//   async initialize(context: Context): Promise<boolean> {
//     try {
//       this.context = context
//
//       return new Promise((resolve) => {
//         relationalStore.getRdbStore(context, DocumentDatabaseManager.STORE_CONFIG, async (err, store) => {
//           if (err) {
//             console.error(`è·å–RdbStoreå¤±è´¥. é”™è¯¯ç :${err.code}, æ¶ˆæ¯:${err.message}`)
//             resolve(false)
//             return
//           }
//
//           this.rdbStore = store
//           console.log('æˆåŠŸè·å–RdbStore')
//
//           // æ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬å¹¶è¿›è¡Œå‡çº§
//           const success = await this.handleDatabaseVersion()
//           resolve(success)
//         })
//       })
//     } catch (error) {
//       console.error('åˆå§‹åŒ–æ•°æ®åº“å¤±è´¥:', error)
//       return false
//     }
//   }
//
//   // å¤„ç†æ•°æ®åº“ç‰ˆæœ¬å‡çº§
//   private async handleDatabaseVersion(): Promise<boolean> {
//     if (!this.rdbStore) return false
//
//     try {
//       let storeVersion = this.rdbStore.version
//
//       // å½“æ•°æ®åº“åˆ›å»ºæ—¶ï¼Œç‰ˆæœ¬ä¸º0ï¼Œéœ€è¦åˆ›å»ºè¡¨
//       if (storeVersion === 0) {
//         await this.rdbStore.execute(DocumentDatabaseManager.SQL_CREATE_DOCUMENTS_TABLE)
//         await this.rdbStore.execute(DocumentDatabaseManager.SQL_CREATE_DOCUMENT_TYPES_TABLE)
//         storeVersion = DocumentDatabaseManager.CURRENT_VERSION
//         console.log('æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ')
//       }
//
//       // è®¾ç½®æ•°æ®åº“ç‰ˆæœ¬
//       this.rdbStore.version = storeVersion
//       console.log('æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼Œç‰ˆæœ¬:', storeVersion)
//       return true
//     } catch (error) {
//       const err = error as BusinessError
//       console.error(`æ•°æ®åº“ç‰ˆæœ¬å¤„ç†å¤±è´¥. é”™è¯¯ç :${err.code}, æ¶ˆæ¯:${err.message}`)
//       return false
//     }
//   }
//
//   // ä¿å­˜æ–‡æ¡£åˆ—è¡¨
//   async saveDocuments(documents: DocumentItem[]): Promise<boolean> {
//     if (!this.rdbStore) {
//       console.error('æ•°æ®åº“æœªåˆå§‹åŒ–')
//       return false
//     }
//
//     try {
//       // å¼€å§‹äº‹åŠ¡
//       await this.rdbStore.beginTransaction()
//
//       // æ¸…ç©ºç°æœ‰æ•°æ®
//       await this.rdbStore.execute('DELETE FROM documents')
//
//       // æ’å…¥æ–°æ•°æ®
//       for (const doc of documents) {
//         const valuesBucket: relationalStore.ValuesBucket = {
//           id: doc.id,
//           name: doc.name,
//           type: doc.type,
//           number: doc.number,
//           expiryDate: doc.expiryDate,
//           imageUrl: doc.imageUrl,
//           createTime: doc.createTime.toISOString(),
//           updateTime: doc.updateTime.toISOString(),
//           dynamicFields: JSON.stringify(Object.fromEntries(doc.dynamicFields)),
//           recognitionConfidence: doc.recognitionConfidence,
//           originalImagePath: doc.originalImagePath
//         }
//
//         await this.rdbStore.insert('documents', valuesBucket)
//       }
//
//       // æäº¤äº‹åŠ¡
//       await this.rdbStore.commit()
//
//       // æ›´æ–°æ–‡æ¡£ç±»å‹ç»Ÿè®¡
//       await this.updateDocumentTypes(documents)
//
//       console.log('æ–‡æ¡£ä¿å­˜æˆåŠŸï¼Œå…±ä¿å­˜', documents.length, 'ä¸ªæ–‡æ¡£')
//       return true
//     } catch (error) {
//       // å›æ»šäº‹åŠ¡
//       if (this.rdbStore) {
//         await this.rdbStore.rollBack()
//       }
//       console.error('ä¿å­˜æ–‡æ¡£å¤±è´¥:', error)
//       return false
//     }
//   }
//
//   // åŠ è½½æ–‡æ¡£åˆ—è¡¨
//   async loadDocuments(): Promise<DocumentItem[]> {
//     if (!this.rdbStore) {
//       console.error('æ•°æ®åº“æœªåˆå§‹åŒ–')
//       return []
//     }
//
//     try {
//       const predicates = new relationalStore.RdbPredicates('documents')
//       const resultSet = await this.rdbStore.query(predicates)
//
//       const documents: DocumentItem[] = []
//       while (resultSet.goToNextRow()) {
//         const dynamicFieldsStr = resultSet.getString(resultSet.getColumnIndex('dynamicFields'))
//         const dynamicFields = new Map<string, string>()
//
//         if (dynamicFieldsStr) {
//           const dynamicFieldsObj = JSON.parse(dynamicFieldsStr)
//           Object.keys(dynamicFieldsObj).forEach(key => {
//             dynamicFields.set(key, dynamicFieldsObj[key])
//           })
//         }
//
//         const document = new DocumentItem(
//           resultSet.getString(resultSet.getColumnIndex('id')),
//           resultSet.getString(resultSet.getColumnIndex('name')),
//           resultSet.getString(resultSet.getColumnIndex('type')),
//           resultSet.getString(resultSet.getColumnIndex('number')),
//           resultSet.getString(resultSet.getColumnIndex('expiryDate')),
//           resultSet.getString(resultSet.getColumnIndex('imageUrl')),
//           new Date(resultSet.getString(resultSet.getColumnIndex('createTime'))),
//           new Date(resultSet.getString(resultSet.getColumnIndex('updateTime'))),
//           dynamicFields,
//           resultSet.getDouble(resultSet.getColumnIndex('recognitionConfidence')),
//           resultSet.getString(resultSet.getColumnIndex('originalImagePath'))
//         )
//         documents.push(document)
//       }
//
//       resultSet.close()
//       console.log('æ–‡æ¡£åŠ è½½æˆåŠŸï¼Œå…±åŠ è½½', documents.length, 'ä¸ªæ–‡æ¡£')
//       return documents
//     } catch (error) {
//       console.error('åŠ è½½æ–‡æ¡£å¤±è´¥:', error)
//       return []
//     }
//   }
//
//   // æ·»åŠ å•ä¸ªæ–‡æ¡£
//   async addDocument(document: DocumentItem): Promise<boolean> {
//     if (!this.rdbStore) {
//       console.error('æ•°æ®åº“æœªåˆå§‹åŒ–')
//       return false
//     }
//
//     try {
//       const valuesBucket: relationalStore.ValuesBucket = {
//         id: document.id,
//         name: document.name,
//         type: document.type,
//         number: document.number,
//         expiryDate: document.expiryDate,
//         imageUrl: document.imageUrl,
//         createTime: document.createTime.toISOString(),
//         updateTime: document.updateTime.toISOString(),
//         dynamicFields: JSON.stringify(Object.fromEntries(document.dynamicFields)),
//         recognitionConfidence: document.recognitionConfidence,
//         originalImagePath: document.originalImagePath
//       }
//
//       await this.rdbStore.insert('documents', valuesBucket)
//
//       // æ›´æ–°æ–‡æ¡£ç±»å‹ç»Ÿè®¡
//       const documents = await this.loadDocuments()
//       await this.updateDocumentTypes(documents)
//
//       console.log('æ–‡æ¡£æ·»åŠ æˆåŠŸ:', document.name)
//       return true
//     } catch (error) {
//       console.error('æ·»åŠ æ–‡æ¡£å¤±è´¥:', error)
//       return false
//     }
//   }
//
//   // æ›´æ–°å•ä¸ªæ–‡æ¡£
//   async updateDocument(document: DocumentItem): Promise<boolean> {
//     if (!this.rdbStore) {
//       console.error('æ•°æ®åº“æœªåˆå§‹åŒ–')
//       return false
//     }
//
//     try {
//       const predicates = new relationalStore.RdbPredicates('documents')
//       predicates.equalTo('id', document.id)
//
//       const valuesBucket: relationalStore.ValuesBucket = {
//         name: document.name,
//         type: document.type,
//         number: document.number,
//         expiryDate: document.expiryDate,
//         imageUrl: document.imageUrl,
//         updateTime: document.updateTime.toISOString(),
//         dynamicFields: JSON.stringify(Object.fromEntries(document.dynamicFields)),
//         recognitionConfidence: document.recognitionConfidence,
//         originalImagePath: document.originalImagePath
//       }
//
//       const rows = await this.rdbStore.update(valuesBucket, predicates)
//
//       if (rows > 0) {
//         // æ›´æ–°æ–‡æ¡£ç±»å‹ç»Ÿè®¡
//         const documents = await this.loadDocuments()
//         await this.updateDocumentTypes(documents)
//
//         console.log('æ–‡æ¡£æ›´æ–°æˆåŠŸ:', document.name)
//         return true
//       }
//       return false
//     } catch (error) {
//       console.error('æ›´æ–°æ–‡æ¡£å¤±è´¥:', error)
//       return false
//     }
//   }
//
//   // åˆ é™¤å•ä¸ªæ–‡æ¡£
//   async deleteDocument(id: string): Promise<boolean> {
//     if (!this.rdbStore) {
//       console.error('æ•°æ®åº“æœªåˆå§‹åŒ–')
//       return false
//     }
//
//     try {
//       const predicates = new relationalStore.RdbPredicates('documents')
//       predicates.equalTo('id', id)
//
//       const rows = await this.rdbStore.delete(predicates)
//
//       if (rows > 0) {
//         // æ›´æ–°æ–‡æ¡£ç±»å‹ç»Ÿè®¡
//         const documents = await this.loadDocuments()
//         await this.updateDocumentTypes(documents)
//
//         console.log('æ–‡æ¡£åˆ é™¤æˆåŠŸï¼ŒID:', id)
//         return true
//       }
//       return false
//     } catch (error) {
//       console.error('åˆ é™¤æ–‡æ¡£å¤±è´¥:', error)
//       return false
//     }
//   }
//
//   // æ ¹æ®IDè·å–æ–‡æ¡£
//   async getDocumentById(id: string): Promise<DocumentItem | null> {
//     if (!this.rdbStore) {
//       console.error('æ•°æ®åº“æœªåˆå§‹åŒ–')
//       return null
//     }
//
//     try {
//       const predicates = new relationalStore.RdbPredicates('documents')
//       predicates.equalTo('id', id)
//
//       const resultSet = await this.rdbStore.query(predicates)
//
//       if (resultSet.goToFirstRow()) {
//         const dynamicFieldsStr = resultSet.getString(resultSet.getColumnIndex('dynamicFields'))
//         const dynamicFields = new Map<string, string>()
//
//         if (dynamicFieldsStr) {
//           const dynamicFieldsObj = JSON.parse(dynamicFieldsStr)
//           Object.keys(dynamicFieldsObj).forEach(key => {
//             dynamicFields.set(key, dynamicFieldsObj[key])
//           })
//         }
//
//         const document = new DocumentItem(
//           resultSet.getString(resultSet.getColumnIndex('id')),
//           resultSet.getString(resultSet.getColumnIndex('name')),
//           resultSet.getString(resultSet.getColumnIndex('type')),
//           resultSet.getString(resultSet.getColumnIndex('number')),
//           resultSet.getString(resultSet.getColumnIndex('expiryDate')),
//           resultSet.getString(resultSet.getColumnIndex('imageUrl')),
//           new Date(resultSet.getString(resultSet.getColumnIndex('createTime'))),
//           new Date(resultSet.getString(resultSet.getColumnIndex('updateTime'))),
//           dynamicFields,
//           resultSet.getDouble(resultSet.getColumnIndex('recognitionConfidence')),
//           resultSet.getString(resultSet.getColumnIndex('originalImagePath'))
//         )
//
//         resultSet.close()
//         return document
//       }
//
//       resultSet.close()
//       return null
//     } catch (error) {
//       console.error('è·å–æ–‡æ¡£å¤±è´¥:', error)
//       return null
//     }
//   }
//
//   // æ ¹æ®ç±»å‹è·å–æ–‡æ¡£
//   async getDocumentsByType(type: string): Promise<DocumentItem[]> {
//     if (!this.rdbStore) {
//       console.error('æ•°æ®åº“æœªåˆå§‹åŒ–')
//       return []
//     }
//
//     try {
//       const predicates = new relationalStore.RdbPredicates('documents')
//       if (type !== 'å…¨éƒ¨') {
//         predicates.equalTo('type', type)
//       }
//
//       const resultSet = await this.rdbStore.query(predicates)
//
//       const documents: DocumentItem[] = []
//       while (resultSet.goToNextRow()) {
//         const dynamicFieldsStr = resultSet.getString(resultSet.getColumnIndex('dynamicFields'))
//         const dynamicFields = new Map<string, string>()
//
//         if (dynamicFieldsStr) {
//           const dynamicFieldsObj = JSON.parse(dynamicFieldsStr)
//           Object.keys(dynamicFieldsObj).forEach(key => {
//             dynamicFields.set(key, dynamicFieldsObj[key])
//           })
//         }
//
//         const document = new DocumentItem(
//           resultSet.getString(resultSet.getColumnIndex('id')),
//           resultSet.getString(resultSet.getColumnIndex('name')),
//           resultSet.getString(resultSet.getColumnIndex('type')),
//           resultSet.getString(resultSet.getColumnIndex('number')),
//           resultSet.getString(resultSet.getColumnIndex('expiryDate')),
//           resultSet.getString(resultSet.getColumnIndex('imageUrl')),
//           new Date(resultSet.getString(resultSet.getColumnIndex('createTime'))),
//           new Date(resultSet.getString(resultSet.getColumnIndex('updateTime'))),
//           dynamicFields,
//           resultSet.getDouble(resultSet.getColumnIndex('recognitionConfidence')),
//           resultSet.getString(resultSet.getColumnIndex('originalImagePath'))
//         )
//         documents.push(document)
//       }
//
//       resultSet.close()
//       return documents
//     } catch (error) {
//       console.error('æ ¹æ®ç±»å‹è·å–æ–‡æ¡£å¤±è´¥:', error)
//       return []
//     }
//   }
//
//   // æœç´¢æ–‡æ¡£
//   async searchDocuments(keyword: string): Promise<DocumentItem[]> {
//     if (!this.rdbStore) {
//       console.error('æ•°æ®åº“æœªåˆå§‹åŒ–')
//       return []
//     }
//
//     try {
//       const predicates = new relationalStore.RdbPredicates('documents')
//       predicates.like('name', `%${keyword}%`)
//         .or()
//         .like('number', `%${keyword}%`)
//         .or()
//         .like('type', `%${keyword}%`)
//
//       const resultSet = await this.rdbStore.query(predicates)
//
//       const documents: DocumentItem[] = []
//       while (resultSet.goToNextRow()) {
//         const dynamicFieldsStr = resultSet.getString(resultSet.getColumnIndex('dynamicFields'))
//         const dynamicFields = new Map<string, string>()
//
//         if (dynamicFieldsStr) {
//           const dynamicFieldsObj = JSON.parse(dynamicFieldsStr)
//           Object.keys(dynamicFieldsObj).forEach(key => {
//             dynamicFields.set(key, dynamicFieldsObj[key])
//           })
//         }
//
//         const document = new DocumentItem(
//           resultSet.getString(resultSet.getColumnIndex('id')),
//           resultSet.getString(resultSet.getColumnIndex('name')),
//           resultSet.getString(resultSet.getColumnIndex('type')),
//           resultSet.getString(resultSet.getColumnIndex('number')),
//           resultSet.getString(resultSet.getColumnIndex('expiryDate')),
//           resultSet.getString(resultSet.getColumnIndex('imageUrl')),
//           new Date(resultSet.getString(resultSet.getColumnIndex('createTime'))),
//           new Date(resultSet.getString(resultSet.getColumnIndex('updateTime'))),
//           dynamicFields,
//           resultSet.getDouble(resultSet.getColumnIndex('recognitionConfidence')),
//           resultSet.getString(resultSet.getColumnIndex('originalImagePath'))
//         )
//         documents.push(document)
//       }
//
//       resultSet.close()
//       return documents
//     } catch (error) {
//       console.error('æœç´¢æ–‡æ¡£å¤±è´¥:', error)
//       return []
//     }
//   }
//
//   // æ›´æ–°æ–‡æ¡£ç±»å‹ç»Ÿè®¡
//   private async updateDocumentTypes(documents: DocumentItem[]): Promise<void> {
//     if (!this.rdbStore) return
//
//     try {
//       // å¼€å§‹äº‹åŠ¡
//       await this.rdbStore.beginTransaction()
//
//       // æ¸…ç©ºç°æœ‰ç±»å‹æ•°æ®
//       await this.rdbStore.execute('DELETE FROM document_types')
//
//       // ç»Ÿè®¡å„ç±»å‹æ–‡æ¡£æ•°é‡
//       const typeCount = new Map<string, number>()
//       documents.forEach(doc => {
//         const count = typeCount.get(doc.type) || 0
//         typeCount.set(doc.type, count + 1)
//       })
//
//       // æ’å…¥ç±»å‹æ•°æ®
//       typeCount.forEach((count, type) => {
//         const valuesBucket: relationalStore.ValuesBucket = {
//           type: type,
//           displayName: type,
//           icon: this.getDocumentTypeIcon(type),
//           count: count
//         }
//         this.rdbStore!.insert('document_types', valuesBucket)
//       })
//
//       // æäº¤äº‹åŠ¡
//       await this.rdbStore.commit()
//     } catch (error) {
//       // å›æ»šäº‹åŠ¡
//       if (this.rdbStore) {
//         await this.rdbStore.rollBack()
//       }
//       console.error('æ›´æ–°æ–‡æ¡£ç±»å‹ç»Ÿè®¡å¤±è´¥:', error)
//     }
//   }
//
//   // è·å–æ–‡æ¡£ç±»å‹åˆ—è¡¨
//   async getDocumentTypes(): Promise<DocumentTypeInfo[]> {
//     if (!this.rdbStore) {
//       return []
//     }
//
//     try {
//       const predicates = new relationalStore.RdbPredicates('document_types')
//       const resultSet = await this.rdbStore.query(predicates)
//
//       const documentTypes: DocumentTypeInfo[] = []
//       while (resultSet.goToNextRow()) {
//         documentTypes.push({
//           type: resultSet.getString(resultSet.getColumnIndex('type')),
//           displayName: resultSet.getString(resultSet.getColumnIndex('displayName')),
//           icon: resultSet.getString(resultSet.getColumnIndex('icon')),
//           count: resultSet.getLong(resultSet.getColumnIndex('count'))
//         })
//       }
//
//       resultSet.close()
//       return documentTypes
//     } catch (error) {
//       console.error('è·å–æ–‡æ¡£ç±»å‹å¤±è´¥:', error)
//       return []
//     }
//   }
//
//   // è·å–æ–‡æ¡£ç±»å‹å›¾æ ‡
//   private getDocumentTypeIcon(type: string): string {
//     const iconMap: Record<string, string> = {
//       'èº«ä»½è¯': 'ğŸ†”',
//       'æŠ¤ç…§': 'ğŸ“˜',
//       'é©¾é©¶è¯': 'ğŸš—',
//       'é“¶è¡Œå¡': 'ğŸ’³',
//       'å…¶ä»–': 'ğŸ“„'
//     }
//     const icon = iconMap[type]
//     return icon || 'ğŸ“„'
//   }
//
//   // æ¸…ç©ºæ‰€æœ‰æ•°æ®
//   async clearAllData(): Promise<boolean> {
//     if (!this.rdbStore) {
//       return false
//     }
//
//     try {
//       await this.rdbStore.execute('DELETE FROM documents')
//       await this.rdbStore.execute('DELETE FROM document_types')
//       console.log('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º')
//       return true
//     } catch (error) {
//       console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error)
//       return false
//     }
//   }
//
//   // å…³é—­æ•°æ®åº“è¿æ¥
//   async close(): Promise<void> {
//     if (this.rdbStore) {
//       await this.rdbStore.close()
//       this.rdbStore = null
//       console.log('æ•°æ®åº“è¿æ¥å·²å…³é—­')
//     }
//   }
// }